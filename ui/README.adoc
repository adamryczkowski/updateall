= Update-All UI
:toc:
:toc-placement: preamble
:icons: font

Rich terminal UI components for the update-all system.

== Overview

This package provides terminal UI components using the Rich library and Textual framework:

* **Progress display** - Real-time progress bars and status updates
* **Tables** - Formatted output for plugin status and results
* **Panels** - Information panels and summaries
* **Live updates** - Streaming output during updates
* **Interactive Tabs** - PTY-based terminal emulation with full interactivity

== Components

=== Interactive Tabbed UI (Recommended)

The interactive tabbed UI provides full terminal emulation with PTY support, allowing for:

* Live output display with ANSI escape sequence support
* Interactive input (sudo prompts, confirmations, etc.)
* Independent scrollback buffer per tab
* Configurable keyboard shortcuts

[source,python]
----
from ui.interactive_tabbed_run import run_with_interactive_tabbed_ui
from ui.key_bindings import KeyBindings

# Run plugins with interactive UI
await run_with_interactive_tabbed_ui(
    plugins=[apt_plugin, flatpak_plugin],
    configs=plugin_configs,
    dry_run=False,
)

# With custom key bindings
custom_bindings = KeyBindings({
    "next_tab": "alt+n",
    "prev_tab": "alt+p",
})
await run_with_interactive_tabbed_ui(
    plugins=[apt_plugin],
    key_bindings=custom_bindings,
)
----

==== Phase Control (New in UI Revision)

The interactive UI supports phase-based execution with pause/resume control:

[source,python]
----
from ui.interactive_tabbed_run import run_with_interactive_tabbed_ui

# Run with phase pause enabled
await run_with_interactive_tabbed_ui(
    plugins=[apt_plugin, flatpak_plugin],
    configs=plugin_configs,
    dry_run=False,
    pause_phases=True,      # Pause before each phase
    max_concurrent=4,       # Limit concurrent operations
)
----

==== Keyboard Shortcuts

[cols="2,3"]
|===
| Shortcut | Action

| `Ctrl+Tab`
| Switch to next tab

| `Ctrl+Shift+Tab`
| Switch to previous tab

| `Alt+1` to `Alt+9`
| Switch to tab N

| `Ctrl+Q`
| Quit application

| `Shift+PageUp`
| Scroll up in history

| `Shift+PageDown`
| Scroll down in history

| `Shift+Home`
| Scroll to top of history

| `Shift+End`
| Scroll to bottom (current output)

| `F1`
| Show help

| `Ctrl+P` / `F8`
| Toggle pause before next phase

| `Ctrl+R` / `F9`
| Retry failed phase

| `Ctrl+S` / `F10`
| Save logs to file

| `Ctrl+H`
| Show detailed help
|===

==== Custom Key Bindings

[source,python]
----
from ui.key_bindings import KeyBindings

# Create custom bindings
bindings = KeyBindings({
    "next_tab": "alt+right",
    "prev_tab": "alt+left",
    "quit": "ctrl+x",
    "scroll_up": "ctrl+up",
    "scroll_down": "ctrl+down",
})

# Available actions:
# - next_tab, prev_tab
# - tab_1 through tab_9
# - quit, help
# - scroll_up, scroll_down, scroll_top, scroll_bottom
# - pause_resume, retry_phase, save_logs, show_help (Phase Control)
----

=== Streaming Tabbed UI (Legacy)

The streaming tabbed UI provides non-interactive output display:

[source,python]
----
from ui.tabbed_run import run_with_tabbed_ui

await run_with_tabbed_ui(
    plugins=[apt_plugin, flatpak_plugin],
    configs=plugin_configs,
    dry_run=False,
    use_streaming=True,
)
----

=== ProgressDisplay

Real-time progress display for update operations:

[source,python]
----
from ui.progress import ProgressDisplay

async with ProgressDisplay() as display:
    display.start_plugin("apt")
    display.update_status("apt", "Updating package lists...")
    display.complete_plugin("apt", success=True)
----

=== ResultsTable

Formatted table for displaying update results:

[source,python]
----
from ui.tables import ResultsTable

table = ResultsTable()
table.add_result(plugin_result)
table.render()
----

=== SummaryPanel

Summary panel showing overall update status:

[source,python]
----
from ui.panels import SummaryPanel

panel = SummaryPanel(results)
panel.render()
----

== Architecture

=== Interactive Tabs Architecture

The interactive tabs feature is built on several components:

[source]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    InteractiveTabbedApp                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    TabbedContent                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚ TerminalPaneâ”‚  â”‚ TerminalPaneâ”‚  â”‚ TerminalPaneâ”‚      â”‚    â”‚
â”‚  â”‚  â”‚   (apt)     â”‚  â”‚  (flatpak)  â”‚  â”‚   (pipx)    â”‚      â”‚    â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚      â”‚    â”‚
â”‚  â”‚  â”‚TerminalView â”‚  â”‚TerminalView â”‚  â”‚TerminalView â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                â”‚                â”‚                   â”‚
â”‚            â–¼                â–¼                â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   PTYSessionManager                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚ PTYSession  â”‚  â”‚ PTYSession  â”‚  â”‚ PTYSession  â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        InputRouter                               â”‚
â”‚  - Navigation keys â†’ App (tab switching)                         â”‚
â”‚  - Other keys â†’ Active PTY                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

==== Components

* **InteractiveTabbedApp** - Main Textual application
* **TerminalPane** - Container combining TerminalView with status bar
* **TerminalView** - Textual widget rendering terminal screen
* **TerminalScreen** - Pyte-based terminal emulator
* **PTYSession** - PTY subprocess wrapper
* **PTYSessionManager** - Manages multiple PTY sessions
* **InputRouter** - Routes keyboard input to appropriate destination
* **KeyBindings** - Configurable key binding system

=== Plugin Interface

Plugins can support interactive mode by implementing:

[source,python]
----
class MyPlugin(UpdatePlugin):
    @property
    def supports_interactive(self) -> bool:
        """Return True to enable interactive mode."""
        return True

    def get_interactive_command(self, dry_run: bool = False) -> list[str]:
        """Return command to run in PTY."""
        if dry_run:
            return ["/usr/bin/apt", "update", "--dry-run"]
        return ["/usr/bin/apt", "update"]
----

== Development

[source,bash]
----
# Install dependencies
just install

# Run tests
just test

# Run linting
just lint

# Run specific test file
just test tests/test_interactive_tabbed_run.py

# Run performance benchmarks
just test tests/test_performance_benchmarks.py
----

=== Test Categories

* **Unit tests** - Test individual components in isolation
* **Integration tests** - Test component interactions
* **E2E tests** - Test complete user workflows (`test_e2e_interactive_tabs.py`)
* **Performance benchmarks** - Measure performance characteristics (`test_performance_benchmarks.py`)

=== Performance Targets

[cols="3,2,2"]
|===
| Operation | Target | Measured

| Plain text processing (10K chars)
| < 100ms
| ~50ms

| ANSI sequence processing (1K sequences)
| < 100ms
| ~30ms

| Scrollback append (10K lines)
| < 100ms
| ~80ms

| Key routing (1K keys)
| < 50ms
| ~10ms

| PTY creation
| < 100ms
| ~50ms

| Input-output latency
| < 50ms
| ~10ms
|===

== Configuration

=== Key Bindings Configuration

Key bindings can be configured via TOML file at `~/.config/update-all/keybindings.toml`:

[source,toml]
----
[tab_navigation]
next_tab = "ctrl+tab"
prev_tab = "ctrl+shift+tab"
tab_1 = "alt+1"
tab_2 = "alt+2"
# ... up to tab_9

[terminal]
scroll_up = "shift+pageup"
scroll_down = "shift+pagedown"
scroll_top = "shift+home"
scroll_bottom = "shift+end"

[app]
quit = "ctrl+q"
help = "f1"
----

=== Terminal Configuration

Terminal pane configuration:

[source,python]
----
from ui.terminal_pane import PaneConfig

config = PaneConfig(
    columns=80,           # Terminal width
    lines=24,             # Terminal height
    scrollback_lines=10000,  # Scrollback buffer size
    show_status_bar=True,    # Show status bar
    show_scrollbar=True,     # Show scrollbar
    env={"TERM": "xterm-256color"},  # Environment variables
    cwd="/home/user",     # Working directory
)
----

== Platform Support

=== Linux

Full support for all features including PTY-based interactive mode.

=== macOS

Full support for all features including PTY-based interactive mode.

=== Windows

PTY is not available on Windows. The system automatically falls back to the streaming tabbed UI (non-interactive mode).

== Dependencies

* `rich` >= 14.0 - Rich text formatting
* `textual` >= 7.0.0, < 8.0.0 - TUI framework
* `pyte` >= 0.8.2 - Terminal emulator
* `ptyprocess` >= 0.7.0 - PTY subprocess management

== License

MIT License

== Migration Guide

=== Migrating from Previous Versions

==== New CLI Options

The following CLI options have been added:

[cols="2,3"]
|===
| Option | Description

| `--pause-phases` / `-P`
| Pause before each phase (Update, Download, Upgrade), requiring confirmation to proceed.

| `--concurrency` / `-j`
| Limit the maximum number of concurrent operations. Default: number of CPU cores.
|===

Example usage:

[source,bash]
----
# Run with phase pausing enabled
update-all run --interactive --pause-phases

# Limit concurrency to 2 operations
update-all run --interactive --concurrency 2

# Combine both options
update-all run -i -P -j 4
----

==== New Keyboard Shortcuts

The following keyboard shortcuts have been added for phase control:

[cols="2,3"]
|===
| Shortcut | Action

| `Ctrl+P` / `F8`
| Toggle pause before next phase. When enabled, the app will pause before transitioning to the next phase.

| `Ctrl+R` / `F9`
| Retry failed phase. Restarts the PTY session for the active pane if it has failed.

| `Ctrl+S` / `F10`
| Save logs to file. Saves the terminal output to `~/.local/share/update-all/logs/`.

| `Ctrl+H`
| Show detailed help with all keyboard shortcuts.
|===

==== API Changes

The `run_with_interactive_tabbed_ui` function now accepts additional parameters:

[source,python]
----
# Before (still works)
await run_with_interactive_tabbed_ui(
    plugins=[apt_plugin],
    configs=plugin_configs,
    dry_run=False,
)

# After (new parameters available)
await run_with_interactive_tabbed_ui(
    plugins=[apt_plugin],
    configs=plugin_configs,
    dry_run=False,
    pause_phases=True,      # NEW: Pause before each phase
    max_concurrent=4,       # NEW: Limit concurrent operations
)
----

The `InteractiveTabbedApp` class also accepts these new parameters:

[source,python]
----
app = InteractiveTabbedApp(
    plugins=[apt_plugin],
    pause_phases=True,
    max_concurrent=4,
)
----

==== Tab Visual Enhancements

Tabs now display:

* **Status icons** - Visual indicators for tab status (ðŸŸ¢ completed, ðŸŸ¡ running, ðŸ”´ error, â¬œ pending, ðŸ”’ locked)
* **Phase labels** - Current phase displayed in tab label (Update, Download, Upgrade)
* **Color coding** - Tab background color changes based on status

==== Status Bar Metrics

Each tab now includes a status bar displaying:

* Current status and ETA
* CPU and memory usage
* Items processed
* Network and disk I/O
* CPU time

==== Backward Compatibility

All existing code continues to work without modification. The new features are opt-in:

* Phase pausing is disabled by default
* Concurrency defaults to CPU count
* New keyboard shortcuts don't conflict with existing ones
* Tab visual enhancements are automatic but non-breaking

== See Also

* link:../docs/interactive-tabs-implementation-plan.md[Interactive Tabs Implementation Plan]
* link:../docs/interactive-tabs-architecture-evaluation.md[Architecture Evaluation]
* link:../docs/interactive-tabs-risk-analysis.md[Risk Analysis]
* link:../docs/UI-revision-plan.md[UI Revision Plan]
